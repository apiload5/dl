# Nginx Configuration - Simplified
files:
  "/etc/nginx/conf.d/savemedia.conf":
    mode: "000644"
    owner: root
    group: root
    content: |
      # SaveMedia Nginx Configuration
      server {
          listen 80;
          server_name _;
          root /var/www/html;
          index index.php index.html;
          
          # Basic security headers
          add_header X-Frame-Options DENY;
          add_header X-Content-Type-Options nosniff;
          add_header X-XSS-Protection "1; mode=block";
          
          # Client settings for large uploads
          client_max_body_size 100M;
          client_body_timeout 300s;
          client_header_timeout 60s;
          
          # PHP processing
          location ~ \.php$ {
              try_files $uri =404;
              fastcgi_pass unix:/var/run/php-fpm/www.sock;
              fastcgi_index index.php;
              fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
              include fastcgi_params;
              fastcgi_read_timeout 300;
              fastcgi_send_timeout 300;
              fastcgi_connect_timeout 60;
          }
          
          # API routes
          location ^~ /api/ {
              try_files $uri $uri/ @api;
          }
          
          location @api {
              rewrite ^/api/(.*)$ /api/$1.php last;
          }
          
          # Static files caching
          location ~* \.(css|js|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {
              expires 30d;
              add_header Cache-Control "public, no-transform";
          }
          
          # Health check
          location = /health {
              try_files $uri /api/health.php;
              access_log off;
          }
          
          # Deny access to sensitive files
          location ~ /\.(ht|git|svn) {
              deny all;
          }
          
          location ~ /(config|includes)/ {
              deny all;
          }
      }

container_commands:
  01_backup_nginx_conf:
    command: "cp /etc/nginx/nginx.conf /etc/nginx/nginx.conf.backup || true"
    ignoreErrors: true
    
  02_test_nginx_config:
    command: "nginx -t"
    ignoreErrors: true
    
  03_reload_nginx:
    command: "service nginx reload"
    ignoreErrors: true
