# SaveMedia Complete AWS Elastic Beanstalk Configuration
# âœ… Compatible with PHP 8.3 (Apache) on Amazon Linux 2023
# ðŸš€ Supports: yt-dlp, FFmpeg, .htaccess, security headers & custom PHP settings

option_settings:
  # Environment configuration
  aws:elasticbeanstalk:environment:
    EnvironmentType: SingleInstance

  # Instance configuration
  aws:autoscaling:launchconfiguration:
    InstanceType: t3.medium
    DisableIMDSv1: true

  # Health monitoring
  aws:elasticbeanstalk:healthreporting:system:
    SystemType: enhanced
    HealthCheckSuccessThreshold: Ok

  # Application environment variables
  aws:elasticbeanstalk:application:environment:
    APP_ENV: production
    APP_DEBUG: false
    PHP_MEMORY_LIMIT: 512M
    UPLOAD_MAX_SIZE: 100M
    FFMPEG_PATH: /usr/bin/ffmpeg
    YTDLP_PATH: /usr/bin/yt-dlp

  # CloudWatch logs
  aws:elasticbeanstalk:cloudwatch:logs:
    StreamLogs: true
    DeleteOnTerminate: false
    RetentionInDays: 7

# System package installation
packages:
  dnf:
    git: []
    wget: []
    curl: []
    unzip: []
    nano: []
    python3: []
    python3-pip: []
    ffmpeg: []
    htop: []

# Custom PHP configuration
files:
  "/etc/php.d/99-savemedia.ini":
    mode: "000644"
    owner: root
    group: root
    content: |
      ; SaveMedia PHP Configuration
      memory_limit = 512M
      max_execution_time = 300
      max_input_time = 300
      post_max_size = 100M
      upload_max_filesize = 100M
      max_file_uploads = 20
      allow_url_fopen = On
      expose_php = Off
      log_errors = On
      error_log = /var/log/php_errors.log
      file_uploads = On
      session.gc_maxlifetime = 3600
      session.cookie_httponly = 1
      session.use_strict_mode = 1
      session.cookie_secure = 0

  # Apache VirtualHost configuration
  "/etc/httpd/conf.d/savemedia.conf":
    mode: "000644"
    owner: root
    group: root
    content: |
      <VirtualHost *:80>
          DocumentRoot /var/www/html
          <Directory /var/www/html>
              AllowOverride All
              Require all granted
          </Directory>

          # Security headers
          Header always set X-Frame-Options DENY
          Header always set X-Content-Type-Options nosniff
          Header always set X-XSS-Protection "1; mode=block"
          Header set Access-Control-Allow-Origin "*"
          Header set Access-Control-Allow-Methods "GET, POST, OPTIONS"
          Header set Access-Control-Allow-Headers "Content-Type, Authorization"

          # Logging
          ErrorLog /var/log/httpd/savemedia_error.log
          CustomLog /var/log/httpd/savemedia_access.log combined
      </VirtualHost>

# Commands run before deployment
commands:
  01_update_system:
    command: dnf update -y
    ignoreErrors: true

  02_install_yt_dlp:
    command: |
      echo "Installing yt-dlp..."
      python3 -m pip install --upgrade pip
      python3 -m pip install --upgrade yt-dlp
      ln -sf /usr/local/bin/yt-dlp /usr/bin/yt-dlp || true
      chmod +x /usr/local/bin/yt-dlp 2>/dev/null || true
      yt-dlp --version || echo "yt-dlp installation failed"
    ignoreErrors: true

  03_create_directories:
    command: |
      mkdir -p /tmp/downloads /var/log/savemedia
      chmod 777 /tmp/downloads
      chmod 755 /var/log/savemedia
      touch /var/log/php_errors.log /var/log/savemedia/app.log
      chmod 666 /var/log/php_errors.log /var/log/savemedia/app.log
    ignoreErrors: true

# Container commands (executed during app deployment)
container_commands:
  00_enable_htaccess:
    command: |
      sed -i 's/AllowOverride None/AllowOverride All/' /etc/httpd/conf/httpd.conf
      systemctl restart httpd
    ignoreErrors: true

  01_restart_services:
    command: |
      echo "Restarting Apache and PHP-FPM..."
      systemctl restart php-fpm
      systemctl restart httpd
    ignoreErrors: true

  02_verify_installation:
    command: |
      echo "=== Verification ==="
      php --version
      ffmpeg -version | head -1 || echo "ffmpeg missing"
      yt-dlp --version || echo "yt-dlp missing"
      echo "===================="
    ignoreErrors: true
